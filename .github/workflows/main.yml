name: CI

on:
  push:
    tags:
      - v*
env:
  FORCE_COLOR: 1
permissions: write-all
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout files from repo
        uses: actions/checkout@v2
      - name: Run tests
        run: npm test
  deploy:
    needs: test
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    steps:
      - name: Checkout files from repo
        uses: actions/checkout@v2
      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only
      - name: Set environment variables
        env:
          DATABASE_URL: ${{secrets.DATABASE_URL}}
          REPO_TOKEN: ${{secrets.REPO_TOKEN}}
          WEBHOOK_TOKEN: ${{secrets.WEBHOOK_TOKEN}}
          AUTH_KEY_URL: ${{vars.AUTH_KEY_URL}}
        run: |
          flyctl secrets set \
            DATABASE_URL=${DATABASE_URL} \
            REPO_TOKEN=${REPO_TOKEN} \
            WEBHOOK_TOKEN=${WEBHOOK_TOKEN}
            AUTH_KEY_URL=${AUTH_KEY_URL}
      - name: Deploy
        run: flyctl deploy --remote-only
